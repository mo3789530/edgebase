# 実装計画

- [ ] 1. プロジェクト構造とコアインターフェースのセットアップ
  - Go + Fiberでプロジェクト構造を作成
  - ディレクトリ構造（models、services、repositories、handlers）を作成
  - CockroachDB、MinIO、MQTTクライアントの初期化コードを実装
  - 設定管理（環境変数、config構造体）を実装
  - _要件: 1.1, 2.1, 3.1_

- [ ] 2. データモデルとデータベース層の実装
- [ ] 2.1 CockroachDBスキーマの作成
  - マイグレーションファイルを作成（nodes、functions、schema_migrations、node_function_deployments、sync_recordsテーブル）
  - インデックスと制約を定義
  - _要件: 1.1, 2.3, 3.1, 4.4, 5.1_

- [ ] 2.2 データモデル構造体の実装
  - Node、Function、SchemaMigration、NodeFunctionDeployment、SyncRecord構造体を定義
  - バリデーション関数を実装
  - _要件: 1.1, 1.2, 2.2, 2.3, 3.2, 4.4_

- [ ]* 2.3 データモデルのプロパティテストを作成
  - **Feature: edge-sync-control-plane, Property 1: データモデルのバリデーション整合性**
  - **Validates: Requirements 1.1, 2.3**

- [ ] 2.4 リポジトリ層の実装
  - NodeRepository、FunctionRepository、SchemaMigrationRepository、SyncRecordRepositoryを実装
  - CRUD操作とクエリメソッドを実装
  - _要件: 1.1, 1.3, 2.1, 2.3, 2.4, 3.1, 3.4, 4.4, 5.1, 5.3_

- [ ]* 2.5 リポジトリ層のユニットテストを作成
  - 各リポジトリのCRUD操作をテスト
  - エラーハンドリングをテスト
  - _要件: 1.1, 2.1, 3.1, 4.4_

- [ ] 3. MinIOアーティファクト管理の実装
- [ ] 3.1 Artifact Managerサービスの実装
  - MinIOクライアントの初期化
  - WASMバイナリのアップロード機能（SHA256ハッシュ計算を含む）
  - 署名付きダウンロードURL生成機能
  - アーティファクト削除機能
  - _要件: 2.1, 2.3, 4.2_

- [ ]* 3.2 Artifact Managerのプロパティテストを作成
  - **Feature: edge-sync-control-plane, Property 2: アップロード・ダウンロードの整合性**
  - **Validates: Requirements 2.1, 4.2**

- [ ]* 3.3 Artifact Managerのユニットテストを作成
  - アップロード機能のテスト
  - ダウンロードURL生成のテスト
  - ハッシュ検証のテスト
  - _要件: 2.1, 2.3, 4.2_

- [ ] 4. Node Managerサービスの実装
- [ ] 4.1 エッジノード登録機能の実装
  - ノード登録ロジック
  - 認証トークン生成（JWT）
  - トークンハッシュ化（bcrypt）
  - _要件: 1.1, 1.2, 7.3_

- [ ] 4.2 ヘルスチェック機能の実装
  - ヘルスチェック受信処理
  - 最終接続時刻の更新
  - ノードステータスの更新（オンライン/オフライン判定）
  - _要件: 1.3, 1.4_

- [ ] 4.3 ノード状態管理機能の実装
  - ノード情報取得
  - ノード一覧取得（フィルタリング機能付き）
  - ノードステータス更新
  - _要件: 1.4, 5.4_

- [ ]* 4.4 Node Managerのプロパティテストを作成
  - **Feature: edge-sync-control-plane, Property 3: トークン生成の一意性**
  - **Validates: Requirements 1.2, 7.3**

- [ ]* 4.5 Node Managerのユニットテストを作成
  - ノード登録のテスト
  - ヘルスチェックのテスト
  - ステータス更新のテスト
  - _要件: 1.1, 1.3, 1.4_

- [ ] 5. Sync Managerサービスの実装
- [ ] 5.1 同期プラン生成機能の実装
  - エッジノードの現在状態とターゲット状態の比較ロジック
  - 追加・削除すべきWASM関数の決定
  - 適用すべきスキーマ変更の決定
  - 実行順序付きアクションリストの生成
  - _要件: 3.3, 4.1, 4.3_

- [ ] 5.2 同期完了通知処理の実装
  - 同期結果の受信と検証
  - エッジノードのデプロイ状態の更新
  - 同期履歴の記録
  - _要件: 4.4, 5.1, 5.3_

- [ ] 5.3 同期履歴管理機能の実装
  - 同期履歴の取得
  - 同期統計の計算
  - _要件: 5.1, 5.3, 6.4_

- [ ]* 5.4 Sync Managerのプロパティテストを作成
  - **Feature: edge-sync-control-plane, Property 4: 同期プランの冪等性**
  - **Validates: Requirements 4.1, 4.3**

- [ ]* 5.5 Sync Managerのユニットテストを作成
  - 同期プラン生成のテスト
  - 差分計算のテスト
  - 同期完了通知のテスト
  - _要件: 4.1, 4.3, 4.4_

- [ ] 6. トランザクション管理の実装
- [ ] 6.1 同期トランザクション処理の実装
  - トランザクション開始・コミット・ロールバック機能
  - エラーハンドリングとロールバックロジック
  - 同期ログの記録
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ]* 6.2 トランザクション管理のプロパティテストを作成
  - **Feature: edge-sync-control-plane, Property 5: トランザクションのアトミック性**
  - **Validates: Requirements 6.1, 6.2, 6.3**

- [ ]* 6.3 トランザクション管理のユニットテストを作成
  - 正常系のトランザクションテスト
  - エラー時のロールバックテスト
  - _要件: 6.1, 6.2, 6.3_

- [ ] 7. REST APIエンドポイントの実装
- [ ] 7.1 エッジノード管理APIの実装
  - POST /api/v1/nodes/register
  - POST /api/v1/nodes/{id}/heartbeat
  - GET /api/v1/nodes/{id}
  - GET /api/v1/nodes
  - _要件: 1.1, 1.3_

- [ ] 7.2 WASM関数管理APIの実装
  - POST /api/v1/functions
  - GET /api/v1/functions/{id}
  - GET /api/v1/functions/{id}/download
  - DELETE /api/v1/functions/{id}
  - _要件: 2.1, 2.4, 4.2_

- [ ] 7.3 同期APIの実装
  - GET /api/v1/nodes/{id}/sync
  - POST /api/v1/nodes/{id}/sync/ack
  - _要件: 4.1, 4.4_

- [ ] 7.4 スキーマ管理APIの実装
  - POST /api/v1/schemas
  - GET /api/v1/schemas
  - _要件: 3.1, 3.3_

- [ ]* 7.5 APIエンドポイントのユニットテストを作成
  - 各エンドポイントのリクエスト/レスポンステスト
  - バリデーションエラーのテスト
  - _要件: 1.1, 2.1, 3.1, 4.1_

- [ ] 8. Sync API Gateway を実装
- [ ] 8.1 テレメトリ同期 API の実装
  - エッジノードからのテレメトリデータ受信エンドポイント
  - データ検証とデータベース保存
  - 同期ステータス更新
  - _要件: 4.4, 5.1, 5.3_

- [ ] 8.2 コマンド配信 API の実装
  - エッジノードへのコマンド配信エンドポイント
  - コマンドキューの管理
  - 実行結果の受信と記録
  - _要件: 4.1, 4.4_

- [ ]* 8.3 Sync API Gateway のユニットテストを作成
  - テレメトリ受信のテスト
  - コマンド配信のテスト
  - エラーハンドリングのテスト
  - _要件: 4.4, 5.1_

- [ ] 9. 認証・認可ミドルウェアの実装
- [ ] 9.1 JWT認証ミドルウェアの実装
  - トークン検証ロジック
  - 認証失敗時のエラーレスポンス
  - ログ記録
  - _要件: 7.1, 7.4_

- [ ] 9.2 TLS設定の実装
  - TLS 1.3設定
  - 証明書管理
  - _要件: 7.2_

- [ ]* 9.3 認証ミドルウェアのユニットテストを作成
  - 有効なトークンのテスト
  - 無効なトークンのテスト
  - 期限切れトークンのテスト
  - _要件: 7.1, 7.4_

- [ ] 10. エラーハンドリングとロギングの実装
- [ ] 10.1 エラーレスポンス標準化の実装
  - エラーコード定義
  - エラーレスポンス構造体
  - リトライ可能フラグの設定
  - _要件: 5.3, 6.2_

- [ ] 10.2 ロギング機能の実装
  - 構造化ログ（JSON形式）
  - ログレベル設定
  - 機密情報のマスキング
  - _要件: 5.3, 6.4, 7.4_

- [ ]* 10.3 エラーハンドリングのユニットテストを作成
  - エラーレスポンス形式のテスト
  - ログ出力のテスト
  - _要件: 5.3, 6.2_

- [ ] 11. MQTT通知機能の実装（オプション）
- [ ] 11.1 MQTTクライアントの実装
  - MQTTブローカー接続
  - 同期通知のパブリッシュ
  - 接続エラーハンドリング
  - _要件: 4.1_

- [ ] 11.2 MQTT有効/無効の設定管理
  - 環境変数による制御
  - フォールバック処理（MQTT無効時）
  - _要件: 4.1_

- [ ]* 11.3 MQTT機能のユニットテストを作成
  - パブリッシュ機能のテスト
  - 接続エラー時のテスト
  - _要件: 4.1_

- [ ] 12. 監視とメトリクスの実装
- [ ] 12.1 メトリクス収集の実装
  - エッジノード数（ステータス別）
  - 同期成功率
  - APIレスポンスタイム
  - データベース接続プール使用率
  - _要件: 5.1, 5.2, 5.3_

- [ ] 12.2 ヘルスチェックエンドポイントの実装
  - GET /health
  - GET /ready
  - データベース接続チェック
  - MinIO接続チェック
  - _要件: 1.3_

- [ ]* 12.3 メトリクス機能のユニットテストを作成
  - メトリクス収集のテスト
  - ヘルスチェックのテスト
  - _要件: 5.1, 5.2_

- [ ] 13. Docker Compose環境の構築
- [ ] 13.1 docker-compose.ymlの作成
  - CockroachDB、MinIO、MQTT、Control Plane APIサービスの定義
  - ボリューム設定
  - ネットワーク設定
  - _要件: 1.1, 2.1_

- [ ] 13.2 初期化スクリプトの作成
  - データベースマイグレーション実行スクリプト
  - MinIOバケット作成スクリプト
  - _要件: 2.1, 3.1_

- [ ] 14. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 15. ドキュメントの作成
- [ ] 15.1 API仕様書の作成
  - OpenAPI/Swagger形式でAPI仕様を記述
  - エンドポイント、リクエスト/レスポンス形式、エラーコードを文書化
  - _要件: 1.1, 2.1, 3.1, 4.1_

- [ ] 15.2 デプロイメントガイドの作成
  - Docker Compose環境のセットアップ手順
  - 環境変数の説明
  - トラブルシューティング
  - _要件: 1.1, 2.1_

- [ ] 16. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 17. WASM関数登録・アーティファクト管理の実装
- [ ] 17.1 関数登録APIの実装
  - POST /api/v1/functions/register
  - 関数メタデータの検証（name、entrypoint、memory_pages、max_execution_ms）
  - 署名付きアップロードURL生成
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 17.2 アーティファクト検証機能の実装
  - WASM バイナリ形式の検証
  - SHA256 チェックサム計算と保存
  - アーティファクト URL の管理
  - _要件: 1.1, 1.4_

- [ ]* 17.3 関数登録のユニットテストを作成
  - 正常系登録のテスト
  - バリデーションエラーのテスト
  - アーティファクト検証のテスト
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 18. 関数デプロイメント管理の実装
- [ ] 18.1 デプロイメント計画生成機能の実装
  - POP セレクター評価ロジック
  - ターゲットエッジノード選択
  - デプロイメント順序の決定
  - _要件: 2.1, 2.2_

- [ ] 18.2 デプロイメント通知配信の実装
  - MQTT デプロイメント通知の送信
  - 通知ペイロード構築（function_id、version、artifact_url、sha256、memory_pages、max_execution_ms）
  - 再試行ロジック
  - _要件: 2.1, 2.2_

- [ ] 18.3 デプロイメント状態追跡の実装
  - エッジノードからのデプロイメント状態報告受信
  - デプロイメント履歴の記録
  - 失敗時のエラー処理
  - _要件: 2.3, 2.4_

- [ ]* 18.4 デプロイメント管理のユニットテストを作成
  - デプロイメント計画生成のテスト
  - 通知配信のテスト
  - 状態追跡のテスト
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 19. ルート管理の実装
- [ ] 19.1 ルート登録・更新APIの実装
  - POST /api/v1/routes
  - PUT /api/v1/routes/{id}
  - DELETE /api/v1/routes/{id}
  - パス・関数マッピングの管理
  - _要件: 7.1, 7.2_

- [ ] 19.2 ルート配信機能の実装
  - ルート変更の検出
  - エッジノードへのルート配信
  - ルート同期状態の追跡
  - _要件: 7.1, 7.2_

- [ ]* 19.3 ルート管理のユニットテストを作成
  - ルート登録・更新のテスト
  - ルート配信のテスト
  - _要件: 7.1, 7.2_

- [ ] 20. 関数バージョニング・ロールバック機能の実装
- [ ] 20.1 バージョン管理システムの実装
  - バージョン番号の自動採番
  - バージョン間の互換性チェック
  - メタデータのバージョン化
  - _要件: 13.1, 13.2_

- [ ] 20.2 ロールバック機能の実装
  - 前のバージョンへの切り替え
  - ロールバック時のデプロイメント
  - ロールバック履歴の記録
  - _要件: 13.1, 13.2_

- [ ]* 20.3 バージョニングのユニットテストを作成
  - バージョン管理のテスト
  - ロールバック処理のテスト
  - _要件: 13.1, 13.2_

- [ ] 21. リソースクォータ・レート制限の実装
- [ ] 21.1 リソースクォータ管理の実装
  - 関数ごとのメモリクォータ設定
  - 実行時間クォータ設定
  - 同時実行数制限設定
  - _要件: 12.1, 12.2_

- [ ] 21.2 レート制限エンジンの実装
  - リクエストレート制限
  - バースト処理対応
  - クォータ超過時の処理
  - _要件: 12.1, 12.2_

- [ ]* 21.3 リソース制限のユニットテストを作成
  - クォータ管理のテスト
  - レート制限のテスト
  - _要件: 12.1, 12.2_

- [ ] 22. 認証・認可の実装
- [ ] 22.1 API キー認証の実装
  - API キー生成・管理
  - API キー検証ロジック
  - キーローテーション機能
  - _要件: 9.1, 9.2_

- [ ] 22.2 リクエスト署名検証の実装
  - HMAC-SHA256 署名検証
  - タイムスタンプ検証（リプレイ攻撃対策）
  - _要件: 9.1, 9.2_

- [ ]* 22.3 認証・認可のユニットテストを作成
  - API キー認証のテスト
  - 署名検証のテスト
  - _要件: 9.1, 9.2_

- [ ] 23. エラーハンドリング・グレースフルデグラデーション
- [ ] 23.1 エラーハンドリング戦略の実装
  - デプロイメント失敗時の処理
  - ネットワークエラーの処理
  - リソース不足エラーの処理
  - _要件: 11.1, 11.2, 11.3_

- [ ] 23.2 フォールバック機構の実装
  - 古いバージョンへの自動ロールバック
  - サーキットブレーカーパターン
  - 部分的なデプロイメント失敗時の処理
  - _要件: 11.1, 11.2_

- [ ]* 23.3 エラーハンドリングのユニットテストを作成
  - エラーシナリオのテスト
  - フォールバック処理のテスト
  - _要件: 11.1, 11.2_

- [ ] 24. 統合テストと E2E テストの実装
- [ ] 24.1 統合テストスイート
  - 関数登録 → デプロイメント → 実行の統合テスト
  - エラーシナリオの統合テスト
  - _要件: 1.1, 2.1, 3.1_

- [ ] 24.2 E2E テストスイート
  - 実際の WASM 関数を使用したテスト
  - 複数エッジノード間のデプロイメントテスト
  - パフォーマンステスト
  - _要件: 1.1, 2.1, 3.1_

- [ ] 25. ドキュメント作成
- [ ] 25.1 WASM 関数管理 API ドキュメント
  - 関数登録・デプロイメント API 仕様
  - ルート管理 API 仕様
  - エラーコード定義
  - _要件: 1.1, 2.1, 7.1_

- [ ] 25.2 デプロイメントガイド
  - WASM 関数のアップロード手順
  - デプロイメント設定ガイド
  - トラブルシューティング
  - _要件: 1.1, 2.1_
