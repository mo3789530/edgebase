# 実装計画

- [ ] 1. プロジェクト構造とコアインターフェースのセットアップ
  - Rustでプロジェクト構造を作成（edge-runner）
  - ディレクトリ構造（domain、application、infrastructure）を作成
  - WasmEdge runtime、MinIO、MQTT クライアントの初期化コードを実装
  - 設定管理（環境変数、config構造体）を実装
  - _要件: 3.1_

- [ ] 2. 関数メタデータとローカルキャッシュ層の実装
- [ ] 2.1 ローカルキャッシュスキーマの設計
  - SQLiteスキーマ設計（functions、deployments、cache_entriesテーブル）
  - インデックスと制約を定義
  - _要件: 5.1, 5.2, 5.3_

- [ ] 2.2 データモデル構造体の実装
  - Function、Deployment、CacheEntry構造体を定義
  - バリデーション関数を実装
  - _要件: 5.1_

- [ ]* 2.3 データモデルのプロパティテストを作成
  - **Feature: wasmEdge-edge-functions, Property 1: キャッシュメタデータの整合性**
  - **Validates: Requirements 5.1, 5.2_

- [ ] 2.4 ローカルストレージリポジトリの実装
  - FunctionRepository、CacheRepository を実装
  - CRUD操作とクエリメソッドを実装
  - _要件: 5.1, 5.2, 5.3_

- [ ]* 2.5 リポジトリ層のユニットテストを作成
  - CRUD操作をテスト
  - エラーハンドリングをテスト
  - _要件: 5.1, 5.2_

- [ ] 3. アーティファクト管理とダウンロード機能の実装
- [ ] 3.1 Artifact Downloaderサービスの実装
  - MinIOクライアントの初期化
  - WASMバイナリのダウンロード機能
  - SHA256チェックサム検証機能
  - ローカルキャッシュへの保存機能
  - _要件: 2.2, 5.1, 5.2_

- [ ]* 3.2 Artifact Downloaderのプロパティテストを作成
  - **Feature: wasmEdge-edge-functions, Property 2: ダウンロード・検証の整合性**
  - **Validates: Requirements 2.2, 5.2_

- [ ]* 3.3 Artifact Downloaderのユニットテストを作成
  - ダウンロード機能のテスト
  - チェックサム検証のテスト
  - エラーハンドリングのテスト
  - _要件: 2.2, 5.2_

- [ ] 4. WasmEdge ランタイムと関数実行エンジンの実装
- [ ] 4.1 WasmEdge ランタイムラッパーの実装
  - WasmEdge VM の初期化と管理
  - メモリ制限の設定（memory_pages）
  - 実行タイムアウト管理（max_execution_ms）
  - _要件: 3.1, 3.4_

- [ ] 4.2 関数実行エンジンの実装
  - WASM モジュールのロードと実行
  - HTTP リクエスト/レスポンスの処理
  - エラーハンドリングと例外処理
  - _要件: 3.1, 3.2, 3.5_

- [ ]* 4.3 実行エンジンのユニットテストを作成
  - 正常系実行のテスト
  - タイムアウト処理のテスト
  - メモリ制限のテスト
  - _要件: 3.1, 3.4_

- [ ] 5. ホットインスタンスプール管理の実装
- [ ] 5.1 インスタンスプール構造体の実装
  - ホットインスタンスプールの初期化
  - min_hot_instances、max_hot_instances の設定
  - idle_timeout の管理
  - _要件: 4.1, 4.2, 4.3_

- [ ] 5.2 LRU キャッシュ戦略の実装
  - LRU エビクション ロジック
  - メモリ圧力監視（80% 閾値）
  - インスタンスの再利用と破棄
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ]* 5.3 インスタンスプールのユニットテストを作成
  - プール初期化のテスト
  - LRU エビクションのテスト
  - アイドルタイムアウトのテスト
  - メモリ圧力処理のテスト
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 6. HTTP ルーティングと要求ディスパッチの実装
- [ ] 6.1 ルートマネージャーの実装
  - ルート登録・更新・削除機能
  - パスマッチング ロジック
  - 関数ルックアップ機能
  - _要件: 3.1_

- [ ] 6.2 HTTP ハンドラーの実装
  - リクエスト受信と検証
  - ホットインスタンスプールからの取得
  - 関数実行のディスパッチ
  - レスポンス返却
  - _要件: 3.1, 3.2, 3.3, 3.5_

- [ ]* 6.3 HTTP ハンドラーのユニットテストを作成
  - ルーティングのテスト
  - ホットインスタンス再利用のテスト
  - コールドスタートのテスト
  - タイムアウト処理のテスト
  - _要件: 3.1, 3.2, 3.3_

- [ ] 7. デプロイメント通知受信と同期の実装
- [ ] 7.1 MQTT クライアントの実装
  - MQTT ブローカーへの接続
  - デプロイメント通知の購読
  - メッセージ処理ロジック
  - _要件: 2.1, 2.2_

- [ ] 7.2 デプロイメント処理パイプラインの実装
  - 通知の解析と検証
  - アーティファクトのダウンロード
  - SHA256 検証
  - ホットインスタンスプールの初期化
  - デプロイメント状態の報告
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ]* 7.3 デプロイメント処理のユニットテストを作成
  - 通知受信のテスト
  - アーティファクト検証のテスト
  - エラーハンドリングのテスト
  - 状態報告のテスト
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 8. ハートビート送信と状態管理の実装
- [ ] 8.1 ハートビート生成エンジンの実装
  - ノード健全性情報の収集
  - 関数インベントリの構築
  - メトリクス情報の集約
  - _要件: 6.1, 6.2_

- [ ] 8.2 ハートビート送信機構の実装
  - 定期的なハートビート送信（デフォルト: 30秒）
  - MQTT での送信
  - 再試行ロジック
  - _要件: 6.1, 6.2_

- [ ]* 8.3 ハートビート機構のユニットテストを作成
  - ハートビート生成のテスト
  - 定期送信のテスト
  - 再試行ロジックのテスト
  - _要件: 6.1, 6.2_

- [ ] 9. メトリクス収集と Prometheus 統合の実装
- [ ] 9.1 メトリクス定義と収集ロジック
  - 関数実行数、レイテンシ、エラー率
  - ホットインスタンス数、キャッシュヒット率
  - メモリ使用量、CPU 使用率
  - _要件: 8.1, 8.2_

- [ ] 9.2 Prometheus エクスポーターの実装
  - /metrics エンドポイント
  - メトリクス形式の出力
  - スクレイピング対応
  - _要件: 8.1, 8.2_

- [ ]* 9.3 メトリクス収集のユニットテストを作成
  - メトリクス更新のテスト
  - Prometheus 形式の検証
  - _要件: 8.1, 8.2_

- [ ] 10. セキュリティと WASM サンドボックス隔離の実装
- [ ] 10.1 WASM サンドボックス設定
  - メモリ隔離の設定
  - ファイルシステムアクセス制限
  - ネットワークアクセス制限
  - _要件: 7.1, 7.2, 7.3_

- [ ]* 10.2 セキュリティのユニットテストを作成
  - サンドボックス隔離のテスト
  - _要件: 7.1_

- [ ] 11. エラーハンドリングとグレースフルデグラデーション
- [ ] 11.1 エラーハンドリング戦略の実装
  - 関数実行エラーの処理
  - ネットワークエラーの処理
  - リソース不足エラーの処理
  - _要件: 11.1, 11.2, 11.3_

- [ ] 11.2 フォールバック機構の実装
  - デプロイメント失敗時の処理
  - 古いバージョンへのロールバック
  - サーキットブレーカーパターン
  - _要件: 11.1, 11.2_

- [ ]* 11.3 エラーハンドリングのユニットテストを作成
  - エラーシナリオのテスト
  - フォールバック処理のテスト
  - _要件: 11.1, 11.2_

- [ ] 12. リソースクォータと レート制限の実装
- [ ] 12.1 リソースクォータ管理
  - 関数ごとのメモリクォータ
  - 実行時間クォータ
  - 同時実行数制限
  - _要件: 12.1, 12.2_

- [ ] 12.2 レート制限エンジン
  - リクエストレート制限
  - バースト処理対応
  - クォータ超過時の処理
  - _要件: 12.1, 12.2_

- [ ]* 12.3 リソース制限のユニットテストを作成
  - クォータ管理のテスト
  - レート制限のテスト
  - _要件: 12.1, 12.2_

- [ ] 13. 関数バージョニングとロールバック機構の実装
- [ ] 13.1 バージョン管理システム
  - バージョン番号の管理
  - バージョン間の互換性チェック
  - メタデータのバージョン化
  - _要件: 13.1, 13.2_

- [ ] 13.2 ロールバック機構
  - 前のバージョンへの切り替え
  - ロールバック時の状態管理
  - デプロイメント履歴の追跡
  - _要件: 13.1, 13.2_

- [ ]* 13.3 バージョニングのユニットテストを作成
  - バージョン管理のテスト
  - ロールバック処理のテスト
  - _要件: 13.1, 13.2_

- [ ] 14. 統合テストと E2E テストの実装
- [ ] 14.1 統合テストスイート
  - デプロイメント → 実行 → メトリクス報告の統合テスト
  - エラーシナリオの統合テスト
  - _要件: 3.1, 4.1_

- [ ] 14.2 E2E テストスイート
  - 実際の WASM 関数を使用したテスト
  - パフォーマンステスト
  - _要件: 3.1, 4.1_

- [ ] 15. ドキュメント作成と デプロイメントガイド
- [ ] 15.1 API ドキュメント
  - HTTP エンドポイント仕様
  - MQTT メッセージ形式
  - エラーコード定義
  - _要件: 3.1_

- [ ] 15.2 デプロイメントガイド
  - インストール手順
  - 設定ガイド
  - トラブルシューティング
  - _要件: 1.1_
